# Malware Analysis

The art of breaking apart malware/code to understand its functionality.

#1. - Virtual Machines
-----------------------------------------
- Windows 10 FlareVM: https://github.com/mandiant/flare-vm
    - FLARE VM is a freely available and open sourced Windows-based security distribution designed for reverse engineers, malware analysts, incident responders, forensicators, and penetration testers. Inspired by open-source Linux-based security distributions like Kali Linux, REMnux and others, FLARE VM delivers a fully configured platform with a comprehensive collection of Windows security tools such as debuggers, disassemblers, decompilers, static and dynamic analysis utilities, network analysis and manipulation, web assessment, exploitation, vulnerability assessment applications, and many others.

- Remnux VM: https://remnux.org/
    - REMnuxÂ® is a Linux toolkit for reverse-engineering and analyzing malicious software. REMnux provides a curated collection of free tools created by the community. Analysts can use it to investigate malware without having to find, install, and configure the tools.

#2. - Static Analysis
-----------------------------------------
The art of analysing malware without execution.

- Basic = looking at any and everything other than the assembly code.

- Advanced = looking at code in a disassembler usually Ghidra/IDA/Binja etc..

We look at the file type, file hash, strings (indicator of what we are dealing with), sections, imports (what API calls the process may make/non-presence could mean the application is packed) etc... Quick win/quick triage = chance of not repeating what fellow researchers have done.

### Basic Static Analysis

- Identify a file type on Windows

```
CyberChef https://gchq.github.io/CyberChef/#recipe=Detect_File_Type(true,true,true,true,true,true,true)
```

- Identify a file type on Linux

```
$ file <file>
```

- Compute a SHA256 hash on Windows

```
PS C:\> Get-FileHash <file>
```

- Compute a SHA256 hash on Linux

```
$ sha256sum <file>
```

- Extract the strings on Windows

```
PS C:\> strings <file>
```

- Extract the strings on Linux

```
$ pestr <file>
```

- Perform a strings comparison between two files using WinMerge (https://winmerge.org/?lang=en)

```
Select two files -> Right-click and select WinMerge 
```

- PEStudio

```
https://www.winitor.com/
```

- CFF Explorer

```
https://ntcore.com/?page_id=388
```

#3. - Dynamic Analysis
-----------------------------------------
The art of analysing malware by execution.

- Basic = looking at any and everything other than the assembly code. Process Monitor (Procmon) logs, ProcDOT flow, Regshot, Wireshark.

- Advanced = executing code in a debugger usually x64dbg/winDbg/OllyDbg etc..

Quickly analyse the malware behaviour/quick overview of the malware by monitoring the OS = get access to artifacts more quickly rather than extracting them statically which can be a pain.

### Basic Dynamic Analysis

- Start a Procmon, Regshot, and Wireshark capture

```
Open Procmon on FlareVM -> Stop the capture -> Options -> Select Columns -> Ensure ProcessID and ThreadID are selected -> Filter -> Process Name contains bot -> Add -> Apply -> OK -> Open Regshot on FlareVM -> Change the scan dir to C:\ drive -> 1st shot -> Open Wireshark on Remnux (don't start the capture yet) -> After Regshot is complete, start the Procmon capture -> Start the Wireshark capture on Remnux -> Start fakedns on Remnux -> Execute the malware on FlareVM -> Terminate the malware after 1 minute using Process Hacker, right-click select Terminate tree -> Stop the Procmon capture -> Regshot 2nd shot -> Check the fakedns and Wireshark logs (search dns in filter bar) for possible C2 domains -> Stop the Wireshark capture -> After Regshot is complete, select Compare -> Compare and Output -> Save the Regshot output file -> Open the Regshot output file in VSCode -> Save the Procmon logs to a CSV file -> Open ProcDOT on FlareVM -> Select 3 dots next to Procmon and select your Procmon log file -> Refresh -> Select 3 dots next to Launcher and select your malware process -> Refresh -> Use the arrow buttons down the bottom to step into the process frame-by-frame
```
